<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rebalance Copilot | 智能資產配置預估</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@500;600;700&family=Manrope:wght@300;400;600;700&display=swap');

    :root {
      --bg-0: #0b1118;
      --bg-1: #0f1a26;
      --bg-2: #102433;
      --card: rgba(255, 255, 255, 0.06);
      --card-strong: rgba(255, 255, 255, 0.12);
      --line: rgba(255, 255, 255, 0.12);
      --ink: #e8eef6;
      --muted: rgba(232, 238, 246, 0.65);
      --accent: #f0c86a;
      --accent-2: #5fd6c2;
      --accent-3: #87a9ff;
      --good: #7bd88f;
      --shadow: 0 26px 70px rgba(4, 10, 20, 0.6);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Manrope", "Avenir Next", system-ui, sans-serif;
      color: var(--ink);
      background:
        radial-gradient(1200px 800px at 5% 5%, rgba(135, 169, 255, 0.18), transparent 60%),
        radial-gradient(900px 600px at 95% 10%, rgba(95, 214, 194, 0.16), transparent 65%),
        linear-gradient(160deg, var(--bg-0), var(--bg-1) 45%, var(--bg-2));
      min-height: 100vh;
    }

    a { color: inherit; text-decoration: none; }

    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }

    .orb {
      position: absolute;
      border-radius: 999px;
      opacity: 0.6;
      mix-blend-mode: screen;
      animation: drift 14s ease-in-out infinite;
      pointer-events: none;
    }

    .orb.one {
      width: 240px;
      height: 240px;
      background: radial-gradient(circle at 30% 30%, rgba(135, 169, 255, 0.7), transparent 70%);
      top: -90px;
      right: -40px;
    }

    .orb.two {
      width: 320px;
      height: 320px;
      background: radial-gradient(circle at 40% 40%, rgba(240, 200, 106, 0.5), transparent 70%);
      bottom: -150px;
      left: -80px;
      animation-delay: -6s;
    }

    @keyframes drift {
      0%, 100% { transform: translateY(0) translateX(0); }
      50% { transform: translateY(18px) translateX(-10px); }
    }

    header {
      padding: 28px clamp(18px, 4vw, 60px) 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .brand {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    .brand-mark {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: linear-gradient(140deg, var(--accent), var(--accent-3));
      display: grid;
      place-items: center;
      color: #0d1218;
      font-weight: 800;
      box-shadow: 0 12px 30px rgba(124, 156, 255, 0.35);
    }

    .hero {
      padding: 18px clamp(18px, 4vw, 60px) 8px;
      display: grid;
      gap: 10px;
    }

    .eyebrow {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid rgba(240, 200, 106, 0.35);
      color: var(--accent);
      font-size: 13px;
      letter-spacing: 0.8px;
      text-transform: uppercase;
      width: fit-content;
    }

    h1 {
      font-family: "Cormorant Garamond", serif;
      font-size: clamp(34px, 4vw, 56px);
      line-height: 1.05;
      margin: 8px 0 0;
    }

    .subtitle {
      color: var(--muted);
      max-width: 760px;
      line-height: 1.7;
    }

    main {
      padding: 18px clamp(18px, 4vw, 60px) 60px;
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
      gap: 24px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 20px;
      padding: 20px;
      box-shadow: var(--shadow);
    }

    .card h2 {
      margin: 0 0 14px;
      font-size: 18px;
      letter-spacing: 0.4px;
    }

    .grid {
      display: grid;
      gap: 14px;
    }

    label {
      display: block;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    input, select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid transparent;
      background: rgba(7, 12, 20, 0.65);
      color: var(--ink);
      font-size: 14px;
      outline: none;
    }

    input:focus, select:focus {
      border-color: rgba(135, 169, 255, 0.7);
      box-shadow: 0 0 0 2px rgba(135, 169, 255, 0.2);
    }

    .row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px;
    }

    .row.tight {
      grid-template-columns: 1fr 120px;
      align-items: center;
    }

    .range-wrap {
      display: grid;
      gap: 6px;
    }

    input[type="range"] {
      accent-color: var(--accent-2);
      height: 4px;
      padding: 0;
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      background: linear-gradient(140deg, var(--accent), #f6dda1);
      color: #1d1500;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    button:hover { transform: translateY(-1px); box-shadow: 0 10px 24px rgba(240, 200, 106, 0.25); }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.12);
      font-size: 12px;
      color: var(--muted);
    }

    .stats {
      display: grid;
      gap: 12px;
      margin-top: 14px;
    }

    .stat {
      padding: 12px 14px;
      border-radius: 14px;
      background: rgba(10, 16, 26, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .stat strong { color: var(--accent); font-size: 18px; }

    .chart {
      height: 260px;
      border-radius: 18px;
      background:
        linear-gradient(120deg, rgba(135, 169, 255, 0.16), rgba(95, 214, 194, 0.08)),
        repeating-linear-gradient(90deg, rgba(255, 255, 255, 0.08) 0 1px, transparent 1px 48px),
        repeating-linear-gradient(0deg, rgba(255, 255, 255, 0.08) 0 1px, transparent 1px 48px);
      border: 1px solid var(--line);
      position: relative;
      overflow: hidden;
    }

    canvas {
      width: 100%;
      height: 100%;
    }

    .note {
      color: var(--muted);
      font-size: 12px;
      line-height: 1.6;
      margin-top: 12px;
    }

    .table {
      display: grid;
      gap: 10px;
    }

    .table-head, .table-row {
      display: grid;
      grid-template-columns: 0.9fr 1.2fr 1fr 1fr 70px;
      gap: 10px;
      align-items: center;
    }

    .allocation-table .table-head,
    .allocation-table .table-row {
      grid-template-columns: 1fr 1fr 1fr 1fr;
    }

    .allocation-table .table-row {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(8, 14, 24, 0.55);
      font-size: 13px;
    }

    .table-head {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .table-row button {
      padding: 8px 10px;
      font-size: 12px;
      background: rgba(255, 255, 255, 0.1);
      color: var(--ink);
    }

    .ticker-cell {
      display: grid;
      gap: 4px;
      align-content: start;
    }

    .ticker-error {
      min-height: 16px;
      font-size: 12px;
      color: #ff8b8b;
      line-height: 1.2;
    }

    .expert-card {
      border: 1px solid rgba(240, 200, 106, 0.55);
      background:
        linear-gradient(160deg, rgba(240, 200, 106, 0.12), rgba(135, 169, 255, 0.06)),
        var(--card);
      box-shadow: 0 20px 60px rgba(240, 200, 106, 0.18), var(--shadow);
      position: relative;
      overflow: hidden;
    }

    .expert-card::after {
      content: "";
      position: absolute;
      inset: -80px auto auto -40px;
      width: 220px;
      height: 220px;
      background: radial-gradient(circle, rgba(240, 200, 106, 0.25), transparent 70%);
      opacity: 0.7;
      pointer-events: none;
    }

    .expert-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(240, 200, 106, 0.18);
      color: var(--accent);
      font-size: 12px;
      letter-spacing: 0.6px;
      text-transform: uppercase;
      margin-bottom: 12px;
    }

    .expert-summary {
      font-size: 15px;
      line-height: 1.7;
      margin: 0 0 12px;
      color: var(--ink);
    }

    .expert-list {
      margin: 0;
      padding-left: 18px;
      display: grid;
      gap: 8px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.6;
    }

    .expert-list li {
      list-style: none;
      position: relative;
      padding-left: 10px;
    }

    .expert-list li::before {
      content: "◆";
      position: absolute;
      left: -12px;
      color: var(--accent);
      font-size: 10px;
      top: 4px;
    }

    footer {
      padding: 18px clamp(18px, 4vw, 60px) 36px;
      color: var(--muted);
      font-size: 12px;
    }

    @media (max-width: 980px) {
      main { grid-template-columns: 1fr; }
      .row { grid-template-columns: 1fr; }
      header { flex-direction: column; align-items: flex-start; }
      .table-head, .table-row { grid-template-columns: 1fr; }
      .table-row button { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="orb one"></div>
    <div class="orb two"></div>

    <header>
      <div class="brand">
        <div class="brand-mark">R</div>
        <div>Rebalance Copilot</div>
      </div>
      <span class="chip" id="universeLabel">Universe: Taiwan stocks (FinMind API)</span>
    </header>

    <section class="hero">
      <span class="eyebrow">Portfolio Forecast Studio</span>
      <h1>輸入台股代碼或名稱，快速預估年化收益、波動率與資產成長曲線。</h1>
      <p class="subtitle">此頁面會即時呼叫台股 API 取得近一年報酬。回測與未來績效皆非保證，請勿視為投資建議。</p>
    </section>

    <main>
      <section class="card">
        <h2>投資條件輸入</h2>
        <div class="grid">
          <div class="table">
            <div class="table-head">
              <div>市場</div>
              <div>代碼</div>
              <div>金額</div>
              <div>幣種</div>
              <div></div>
            </div>
            <div id="rows"></div>
          </div>
          <div class="actions">
            <button id="addRow">新增標的</button>
            <span class="chip">最多 10 檔</span>
          </div>
          <div class="row">
            <div>
              <label for="years">投資期限（1 - 30 年）</label>
              <input id="years" type="range" min="1" max="30" value="10" />
            </div>
            <div>
              <label for="yearsNumber">年數</label>
              <input id="yearsNumber" type="number" min="1" max="30" value="10" />
            </div>
          </div>
          <div class="row">
            <div>
              <label for="age">年齡</label>
              <input id="age" type="number" min="18" max="90" value="35" />
            </div>
            <div>
              <label for="riskLevel">風險承受等級</label>
              <select id="riskLevel">
                <option value="conservative">保守</option>
                <option value="balanced" selected>中性</option>
                <option value="aggressive">積極</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div>
              <label for="taxRegion">主要稅務地區</label>
              <select id="taxRegion">
                <option value="TW" selected>台灣 (TW)</option>
                <option value="US">美國 (US)</option>
                <option value="HK">香港 (HK)</option>
                <option value="SG">新加坡 (SG)</option>
              </select>
            </div>
            <div>
              <label for="displayCurrency">報表幣種</label>
              <select id="displayCurrency">
                <option value="USD" selected>USD 美元</option>
                <option value="TWD">TWD 台幣</option>
                <option value="HKD">HKD 港幣</option>
                <option value="JPY">JPY 日圓</option>
                <option value="CNY">CNY 人民幣</option>
                <option value="EUR">EUR 歐元</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div>
              <label for="override">手動調整年化報酬（%）</label>
              <input id="override" type="number" min="-95" max="50" step="0.1" value="8.0" disabled />
            </div>
          </div>
          <div class="actions">
            <button id="calcBtn">更新預估結果</button>
            <button id="shareBtn" type="button">複製分享連結</button>
            <label class="chip" style="cursor:pointer;">
              <input id="overrideToggle" type="checkbox" style="margin:0;" />
              使用手動年化報酬
            </label>
            <span class="chip" id="scenarioId">Scenario: --</span>
          </div>
        </div>
      </section>

      <section class="card">
        <h2>預估輸出</h2>
        <div class="stats">
          <div class="stat">
            <span>預期年化收益率</span>
            <strong id="outputRate">--</strong>
          </div>
          <div class="stat">
            <span>年化波動率</span>
            <strong id="outputVol">--</strong>
          </div>
          <div class="stat">
            <span>最大回撤（模擬）</span>
            <strong id="outputDD">--</strong>
          </div>
          <div class="stat">
            <span>期末資產總額</span>
            <strong id="outputTotal">--</strong>
          </div>
          <div class="stat">
            <span>累積收益</span>
            <strong id="outputGain">--</strong>
          </div>
        </div>
        <div style="margin-top:16px;">
          <div class="chart">
            <canvas id="trend"></canvas>
          </div>
        </div>
        <div class="note" id="assumptionNote"></div>
      </section>

      <section class="card allocation-table">
        <h2>配置優化建議</h2>
        <div class="table">
          <div class="table-head">
            <div>資產類別</div>
            <div>目前占比</div>
            <div>建議占比</div>
            <div>調整方向</div>
          </div>
          <div id="allocationRows"></div>
        </div>
      </section>

      <section class="card expert-card">
        <h2>專家建議（個性化）</h2>
        <div class="expert-badge">Expert Insight</div>
        <p class="expert-summary" id="expertSummary">--</p>
        <ul class="expert-list" id="expertList"></ul>
      </section>
    </main>

    <footer>
      台股模式：年化報酬率由 API 提供（FinMind），美股目前暫不開放。
    </footer>
  </div>

  <script>
    const API_BASE_URL = (() => {
      const host = (window.location.hostname || '').toLowerCase();
      if (host === 'localhost' || host === '127.0.0.1') {
        return `http://${host}:8000`;
      }
      // Production/staging should call same-origin API routes.
      return '';
    })();
    const FX_RATES = { USD: 1, TWD: 0.032, HKD: 0.128, JPY: 0.0068, CNY: 0.14, EUR: 1.08 };
    const RISK_MODELS = {
      conservative: { returnBias: -0.01, volScale: 0.78, stockTarget: 0.45, bondTarget: 0.4, cashTarget: 0.15 },
      balanced: { returnBias: 0, volScale: 0.9, stockTarget: 0.65, bondTarget: 0.25, cashTarget: 0.1 },
      aggressive: { returnBias: 0.015, volScale: 1.05, stockTarget: 0.8, bondTarget: 0.15, cashTarget: 0.05 }
    };

    const rowsEl = document.getElementById('rows');
    const yearsEl = document.getElementById('years');
    const yearsNumberEl = document.getElementById('yearsNumber');
    const displayCurrencyEl = document.getElementById('displayCurrency');
    const overrideEl = document.getElementById('override');
    const overrideToggleEl = document.getElementById('overrideToggle');
    const ageEl = document.getElementById('age');
    const riskLevelEl = document.getElementById('riskLevel');
    const taxRegionEl = document.getElementById('taxRegion');
    const scenarioIdEl = document.getElementById('scenarioId');
    const allocationRowsEl = document.getElementById('allocationRows');

    const outputRateEl = document.getElementById('outputRate');
    const outputVolEl = document.getElementById('outputVol');
    const outputDDEl = document.getElementById('outputDD');
    const outputTotalEl = document.getElementById('outputTotal');
    const outputGainEl = document.getElementById('outputGain');
    const assumptionNoteEl = document.getElementById('assumptionNote');
    const expertSummaryEl = document.getElementById('expertSummary');
    const expertListEl = document.getElementById('expertList');

    const canvas = document.getElementById('trend');
    const ctx = canvas.getContext('2d');

    function formatCurrency(value, currency) {
      try { return new Intl.NumberFormat('en-US', { style: 'currency', currency, maximumFractionDigits: 0 }).format(value); }
      catch (_) { return `${value.toFixed(0)} ${currency}`; }
    }

    function hashCode(str) { let hash = 0; for (let i = 0; i < str.length; i++) { hash = ((hash << 5) - hash) + str.charCodeAt(i); hash |= 0; } return Math.abs(hash); }
    function seededRandom(seed) { const x = Math.sin(seed) * 10000; return x - Math.floor(x); }
    function mulberry32(a) { return function() { let t = a += 0x6D2B79F5; t = Math.imul(t ^ (t >>> 15), t | 1); t ^= t + Math.imul(t ^ (t >>> 7), t | 61); return ((t ^ (t >>> 14)) >>> 0) / 4294967296; }; }

    function normalizeTicker(ticker) {
      return (ticker || '').trim().toUpperCase();
    }

    function estimateVolFromReturn(expectedReturn) {
      const baseline = 0.14;
      const scaled = Math.abs(expectedReturn) * 1.8;
      return Math.max(0.1, Math.min(0.45, baseline + scaled));
    }

    function createRow(ticker = '', amount = 0, currency = 'TWD', market = 'TW') {
      const row = document.createElement('div');
      row.className = 'table-row';
      row.innerHTML = `
        <select class="market" disabled><option value="TW" selected>台股 TW</option></select>
        <div class="ticker-cell">
          <input class="ticker" type="text" placeholder="例：2330 或 台積電" value="${ticker}" />
          <div class="ticker-error"></div>
        </div>
        <input class="amount" type="number" min="0" step="100" value="${amount}" />
        <select class="currency"><option value="USD" ${currency === 'USD' ? 'selected' : ''}>USD</option><option value="TWD" ${currency === 'TWD' ? 'selected' : ''}>TWD</option><option value="HKD" ${currency === 'HKD' ? 'selected' : ''}>HKD</option><option value="JPY" ${currency === 'JPY' ? 'selected' : ''}>JPY</option><option value="CNY" ${currency === 'CNY' ? 'selected' : ''}>CNY</option><option value="EUR" ${currency === 'EUR' ? 'selected' : ''}>EUR</option></select>
        <button type="button" class="remove">移除</button>`;
      row.querySelector('.remove').addEventListener('click', () => { row.remove(); calculate(); });
      row.querySelectorAll('input, select').forEach(el => el.addEventListener('input', calculate));
      return row;
    }

    function addRow(ticker, amount, currency, market = 'TW') { if (rowsEl.children.length >= 10) return; rowsEl.appendChild(createRow(ticker, amount, currency, market)); }

    function getRows() {
      return Array.from(rowsEl.querySelectorAll('.table-row')).map(row => {
        const market = 'TW';
        const ticker = row.querySelector('.ticker').value.trim();
        const amount = Math.max(0, Number(row.querySelector('.amount').value || 0));
        const currency = row.querySelector('.currency').value;
        const normalizedTicker = normalizeTicker(ticker);
        return { rowEl: row, market, ticker, normalizedTicker, amount, currency };
      }).filter(r => r.ticker || r.amount > 0);
    }

    async function fetchAnnualReturn(query) {
      const response = await fetch(`${API_BASE_URL}/api/v1/tw-stock/annual-return`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query })
      });
      let payload = null;
      try { payload = await response.json(); } catch (_) { payload = null; }
      if (!response.ok) {
        const err = new Error(payload?.message || 'API request failed.');
        err.status = response.status;
        err.payload = payload;
        throw err;
      }
      return payload;
    }

    function setTickerError(rowEl, message = '') {
      const errorEl = rowEl.querySelector('.ticker-error');
      if (errorEl) errorEl.textContent = message || '';
    }

    function describeApiError(err) {
      const code = err?.payload?.error_code || '';
      if (code === 'STOCK_NOT_FOUND') return '查無此台股代碼或名稱。';
      if (code === 'AMBIGUOUS_NAME') return '名稱對應多筆，請改用代碼。';
      if (code === 'INVALID_QUERY') return '輸入格式不正確。';
      if (code === 'NO_PRICE_DATA') return '查無可用價格資料。';
      if (code === 'UPSTREAM_ERROR') return '行情服務暫時異常，請稍後再試。';
      if (code === 'CONFIG_ERROR') return '後端尚未設定 API Token。';
      return err?.payload?.message || err?.message || '查詢失敗，請稍後再試。';
    }

    function buildUserProfile() {
      const age = Math.max(18, Math.min(90, Number(ageEl.value || 35)));
      ageEl.value = age;
      return { age, taxRegion: taxRegionEl.value, riskLevel: riskLevelEl.value, horizonYears: Number(yearsEl.value || 10) };
    }

    function syncYearsFromRange() { yearsNumberEl.value = yearsEl.value; }
    function syncYearsFromNumber() { let val = Number(yearsNumberEl.value || 1); if (val < 1) val = 1; if (val > 30) val = 30; yearsNumberEl.value = val; yearsEl.value = val; }

    function drawChart(values) {
      const width = canvas.clientWidth; const height = canvas.clientHeight; canvas.width = width; canvas.height = height; ctx.clearRect(0, 0, width, height);
      const padding = 36; const maxVal = Math.max(...values); const minVal = Math.min(...values); const range = maxVal - minVal || 1;
      ctx.strokeStyle = 'rgba(255,255,255,0.2)'; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(padding,padding); ctx.lineTo(padding,height-padding); ctx.lineTo(width-padding,height-padding); ctx.stroke();
      const points = values.map((val, index) => ({ x: padding + (index / (values.length - 1 || 1)) * (width - padding * 2), y: height - padding - ((val - minVal) / range) * (height - padding * 2), val }));
      ctx.beginPath(); ctx.moveTo(points[0].x, points[0].y); points.slice(1).forEach(p => ctx.lineTo(p.x, p.y)); ctx.strokeStyle = '#f0c86a'; ctx.lineWidth = 2.5; ctx.stroke();
      ctx.lineTo(points[points.length - 1].x, height - padding); ctx.lineTo(points[0].x, height - padding); ctx.closePath(); ctx.fillStyle = 'rgba(240,200,106,0.12)'; ctx.fill();
    }

    function randnWithRng(rng) { let u = 0, v = 0; while (u === 0) u = rng(); while (v === 0) v = rng(); return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v); }
    function simulatePath(initial, years, mu, sigma, seed) {
      const steps = Math.max(12, years * 12); const dt = 1 / 12; const values = [initial]; let current = initial; const rng = mulberry32(seed);
      for (let i = 0; i < steps; i++) { const shock = randnWithRng(rng); const growth = (mu - 0.5 * sigma * sigma) * dt + sigma * Math.sqrt(dt) * shock; current = Math.max(0, current * Math.exp(growth)); values.push(current); }
      return values;
    }
    function maxDrawdown(series) { let peak = series[0]; let maxDD = 0; series.forEach(val => { if (val > peak) peak = val; const dd = peak ? (peak - val) / peak : 0; if (dd > maxDD) maxDD = dd; }); return maxDD; }

    function computeSuggestedTargets(profile) {
      const base = RISK_MODELS[profile.riskLevel] || RISK_MODELS.balanced;
      const ageAdj = profile.age >= 55 ? -0.08 : profile.age <= 30 ? 0.05 : 0;
      const horizonAdj = profile.horizonYears >= 15 ? 0.04 : profile.horizonYears <= 3 ? -0.06 : 0;
      const stockTarget = Math.max(0.25, Math.min(0.9, base.stockTarget + ageAdj + horizonAdj));
      const cashTarget = Math.max(0.05, Math.min(0.25, base.cashTarget + (profile.taxRegion === 'TW' ? 0.01 : 0)));
      const bondTarget = Math.max(0.05, 1 - stockTarget - cashTarget);
      return { stock: stockTarget, bond: bondTarget, cash: cashTarget };
    }

    function suggestAllocation(details, profile) {
      const current = { stock: 0, bond: 0, cash: 0 };
      details.forEach(item => {
        const t = item.normalizedTicker;
        if (!t) { current.cash += item.weight; return; }
        if (['BND','AGG','TLT','IEF','00679B.TW'].includes(t)) current.bond += item.weight;
        else if (['CASH','USD'].includes(t)) current.cash += item.weight;
        else current.stock += item.weight;
      });
      const target = computeSuggestedTargets(profile);
      const rows = [
        { bucket: '股票', currentWeight: current.stock, targetWeight: target.stock },
        { bucket: '債券', currentWeight: current.bond, targetWeight: target.bond },
        { bucket: '現金', currentWeight: current.cash, targetWeight: target.cash },
      ].map(r => ({ ...r, delta: r.targetWeight - r.currentWeight, rationale: r.delta > 0 ? '建議提高配置' : (r.delta < 0 ? '建議降低配置' : '維持現況') }));
      return rows;
    }

    function renderAllocation(rows) {
      allocationRowsEl.innerHTML = rows.map(r => `<div class="table-row"><div>${r.bucket}</div><div>${(r.currentWeight*100).toFixed(1)}%</div><div>${(r.targetWeight*100).toFixed(1)}%</div><div>${r.delta >= 0 ? '+' : ''}${(r.delta*100).toFixed(1)}% (${r.rationale})</div></div>`).join('');
    }

    function generateAdvice(details, years, portfolioReturn, portfolioVol, dd, profile, suggestions) {
      const top = details.slice().sort((a,b)=>b.weight-a.weight)[0];
      const topLabel = top ? `${top.normalizedTicker || '現金'} (${(top.weight*100).toFixed(0)}%)` : '無';
      const riskWord = profile.riskLevel === 'conservative' ? '保守' : profile.riskLevel === 'aggressive' ? '積極' : '中性';
      return {
        summary: `依 ${profile.age} 歲、${profile.taxRegion} 稅務地區與 ${riskWord}風險等級，組合目前最大持倉為 ${topLabel}，模擬回撤 ${(dd*100).toFixed(1)}%。`,
        bullets: [
          `建議配置：股票 ${(suggestions[0].targetWeight*100).toFixed(0)}% / 債券 ${(suggestions[1].targetWeight*100).toFixed(0)}% / 現金 ${(suggestions[2].targetWeight*100).toFixed(0)}%。`,
          years <= 3 ? '期限偏短，建議提高防禦資產比例。' : (years >= 15 ? '期限偏長，可維持成長配置並定期再平衡。' : '期限中等，維持股債平衡配置。'),
          portfolioVol >= 0.24 ? '波動偏高，請確認心理承受度與現金備援。' : '波動尚可，重點是紀律執行再平衡。',
          portfolioReturn >= 0.1 ? '預期報酬偏積極，需搭配風險管理。' : '預期報酬中性至保守，可依目標調整。'
        ]
      };
    }

    function seedFromScenario(profile, rows, years, displayCurrency, overrideState) {
      const payload = JSON.stringify({ profile, rows: rows.map(r => ({...r, amount: Number(r.amount.toFixed(2))})), years, displayCurrency, overrideState });
      return hashCode(payload) || 1;
    }

    function base64EncodeUnicode(str) { return btoa(unescape(encodeURIComponent(str))); }
    function base64DecodeUnicode(str) { return decodeURIComponent(escape(atob(str))); }

    function serializeScenarioToQuery(profile, rows, years, displayCurrency, override) {
      const data = { profile, rows, years, displayCurrency, override };
      return new URLSearchParams({ s: base64EncodeUnicode(JSON.stringify(data)) }).toString();
    }

    function hydrateScenarioFromQuery() {
      const params = new URLSearchParams(window.location.search);
      const raw = params.get('s');
      if (!raw) return null;
      try { return JSON.parse(base64DecodeUnicode(raw)); } catch (_) { return null; }
    }

    let latestCalcRun = 0;
    async function calculate() {
      const runId = ++latestCalcRun;
      const years = Number(yearsEl.value || 1);
      const displayCurrency = displayCurrencyEl.value;
      const rows = getRows();
      const profile = buildUserProfile();
      const risk = RISK_MODELS[profile.riskLevel] || RISK_MODELS.balanced;

      if (!rows.length) {
        outputRateEl.textContent = '--'; outputVolEl.textContent = '--'; outputDDEl.textContent = '--'; outputTotalEl.textContent = '--'; outputGainEl.textContent = '--';
        drawChart([0, 1]); assumptionNoteEl.textContent = '請至少輸入一檔代碼與金額。'; expertSummaryEl.textContent = '--'; expertListEl.innerHTML = ''; allocationRowsEl.innerHTML = '';
        return;
      }

      let totalUsd = 0;
      const details = [];
      const invalidRows = [];
      for (const row of rows) {
        const fx = FX_RATES[row.currency] || 1;
        const amountUsd = row.amount * fx;
        totalUsd += amountUsd;
        row.rowEl.querySelector('.ticker').style.borderColor = '';
        setTickerError(row.rowEl, '');
        if (!row.normalizedTicker) {
          details.push({ ...row, amountUsd, expectedReturn: 0.01, volatility: 0.02, isCash: true });
          continue;
        }
        try {
          const apiData = await fetchAnnualReturn(row.normalizedTicker);
          const expectedReturn = Number(apiData.annual_return);
          details.push({
            ...row,
            amountUsd,
            normalizedTicker: apiData.resolved_stock_id,
            resolvedStockName: apiData.resolved_stock_name,
            expectedReturn,
            volatility: estimateVolFromReturn(expectedReturn),
            isCash: false
          });
        } catch (err) {
          const explain = describeApiError(err);
          invalidRows.push({
            query: row.normalizedTicker,
            message: explain
          });
          row.rowEl.querySelector('.ticker').style.borderColor = 'rgba(255, 90, 90, 0.9)';
          setTickerError(row.rowEl, explain);
        }
      }

      if (runId !== latestCalcRun) return;

      if (invalidRows.length) {
        outputRateEl.textContent = '--'; outputVolEl.textContent = '--'; outputDDEl.textContent = '--'; outputTotalEl.textContent = '--'; outputGainEl.textContent = '--';
        drawChart([0, 1]);
        expertSummaryEl.textContent = '--';
        expertListEl.innerHTML = '';
        allocationRowsEl.innerHTML = '';
        assumptionNoteEl.textContent = `輸入不通過：${invalidRows.map(x => `${x.query}（${x.message}）`).join('；')}`;
        return;
      }

      if (totalUsd === 0) {
        outputRateEl.textContent = '--'; outputVolEl.textContent = '--'; outputDDEl.textContent = '--'; outputTotalEl.textContent = '--'; outputGainEl.textContent = '--';
        drawChart([0, 1]); assumptionNoteEl.textContent = '投資金額需大於 0。'; expertSummaryEl.textContent = '--'; expertListEl.innerHTML = ''; allocationRowsEl.innerHTML = '';
        return;
      }

      details.forEach(item => { item.weight = item.amountUsd / totalUsd; });
      let weightedReturn = 0, weightedVar = 0;
      details.forEach(item => { weightedReturn += item.weight * item.expectedReturn; weightedVar += Math.pow(item.weight * item.volatility, 2); });

      let portfolioReturn = weightedReturn + risk.returnBias;
      if (overrideToggleEl.checked) portfolioReturn = Math.max(-0.95, Math.min(0.5, Number(overrideEl.value) / 100));
      portfolioReturn = Math.max(-0.95, Math.min(0.5, portfolioReturn));
      const portfolioVol = Math.sqrt(weightedVar) * risk.volScale;

      const finalUsd = totalUsd * Math.pow(1 + portfolioReturn, years);
      const gainUsd = finalUsd - totalUsd;
      const fxOut = FX_RATES[displayCurrency] || 1;
      outputRateEl.textContent = `${(portfolioReturn * 100).toFixed(2)}%`;
      outputVolEl.textContent = `${(portfolioVol * 100).toFixed(2)}%`;

      const overrideState = { enabled: overrideToggleEl.checked, value: Number(overrideEl.value) };
      const seed = seedFromScenario(profile, rows, years, displayCurrency, overrideState);
      const path = simulatePath(totalUsd, years, portfolioReturn, portfolioVol, seed);
      const dd = maxDrawdown(path);
      outputDDEl.textContent = `${(dd * 100).toFixed(2)}%`;
      outputTotalEl.textContent = formatCurrency(finalUsd / fxOut, displayCurrency);
      outputGainEl.textContent = formatCurrency(gainUsd / fxOut, displayCurrency);
      drawChart(path.map(v => v / fxOut));

      const suggestions = suggestAllocation(details, profile);
      renderAllocation(suggestions);
      const advice = generateAdvice(details, years, portfolioReturn, portfolioVol, dd, profile, suggestions);
      expertSummaryEl.textContent = advice.summary;
      expertListEl.innerHTML = advice.bullets.map(item => `<li>${item}</li>`).join('');

      scenarioIdEl.textContent = `Scenario: ${seed}`;
      const resolved = details.filter(d => d.resolvedStockName).map(d => `${d.normalizedTicker} ${d.resolvedStockName}`);
      const resolvedNote = resolved.length ? `已解析：${resolved.join('、')}` : '無股票代碼輸入。';
      assumptionNoteEl.textContent = `估算依據：台股 API 近一年報酬 + ${profile.riskLevel}風險模型 + ${profile.taxRegion}稅務地區假設 + 靜態匯率；${resolvedNote}`;

      const query = serializeScenarioToQuery(profile, rows, years, displayCurrency, overrideState);
      history.replaceState(null, '', `${location.pathname}?${query}`);
    }

    function copyShareUrl() {
      navigator.clipboard.writeText(window.location.href).then(() => {
        scenarioIdEl.textContent = `${scenarioIdEl.textContent} · 已複製`;
      }).catch(() => {
        scenarioIdEl.textContent = `${scenarioIdEl.textContent} · 請手動複製網址`;
      });
    }

    yearsEl.addEventListener('input', () => { syncYearsFromRange(); calculate(); });
    yearsNumberEl.addEventListener('input', () => { syncYearsFromNumber(); calculate(); });
    overrideToggleEl.addEventListener('change', () => { overrideEl.disabled = !overrideToggleEl.checked; calculate(); });
    document.getElementById('calcBtn').addEventListener('click', calculate);
    document.getElementById('shareBtn').addEventListener('click', copyShareUrl);
    document.getElementById('addRow').addEventListener('click', () => { addRow('', 0, 'TWD', 'TW'); calculate(); });
    [displayCurrencyEl, overrideEl, ageEl, riskLevelEl, taxRegionEl].forEach(el => el.addEventListener('input', calculate));

    function init() {
      const scenario = hydrateScenarioFromQuery();
      if (scenario) {
        rowsEl.innerHTML = '';
        const profile = scenario.profile || {};
        ageEl.value = profile.age || 35;
        riskLevelEl.value = profile.riskLevel || 'balanced';
        taxRegionEl.value = profile.taxRegion || 'TW';
        yearsEl.value = scenario.years || 10;
        yearsNumberEl.value = scenario.years || 10;
        displayCurrencyEl.value = scenario.displayCurrency || 'USD';
        overrideToggleEl.checked = Boolean(scenario.override?.enabled);
        overrideEl.disabled = !overrideToggleEl.checked;
        overrideEl.value = scenario.override?.value ?? 8.0;
        (scenario.rows || []).forEach(r => addRow(r.ticker || '', r.amount || 0, r.currency || 'TWD', 'TW'));
      } else {
        addRow('2330', 100000, 'TWD', 'TW');
        addRow('0050', 60000, 'TWD', 'TW');
        addRow('2454', 40000, 'TWD', 'TW');
        syncYearsFromRange();
      }
      calculate();
    }

    init();
  </script>
</body>
</html>
